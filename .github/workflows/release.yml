name: Release

on:
    push:
        tags:
            - "v*"

permissions:
    contents: write
    packages: write

env:
    REGISTRY: ghcr.io
    IMAGE_PREFIX: ghcr.io/${{ github.repository_owner }}/zero-day-guardian

jobs:
    release-images:
        name: Build & Push Release Images
        runs-on: ubuntu-latest
        strategy:
            matrix:
                include:
                    - component: ebpf-monitor
                      context: ebpf-monitor
                    - component: detection-engine
                      context: detection-engine
                    - component: guardian-operator
                      context: guardian-operator
        steps:
            - uses: actions/checkout@v4

            - name: Log in to GHCR
              uses: docker/login-action@v3
              with:
                  registry: ${{ env.REGISTRY }}
                  username: ${{ github.actor }}
                  password: ${{ secrets.GITHUB_TOKEN }}

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v3

            - name: Extract version from tag
              id: version
              run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

            - name: Build and push
              uses: docker/build-push-action@v5
              with:
                  context: ${{ matrix.context }}
                  push: true
                  tags: |
                      ${{ env.IMAGE_PREFIX }}/${{ matrix.component }}:${{ github.ref_name }}
                      ${{ env.IMAGE_PREFIX }}/${{ matrix.component }}:${{ steps.version.outputs.VERSION }}
                      ${{ env.IMAGE_PREFIX }}/${{ matrix.component }}:latest
                  cache-from: type=gha
                  cache-to: type=gha,mode=max

    release-manifests:
        name: Package Manifests
        runs-on: ubuntu-latest
        needs: release-images
        steps:
            - uses: actions/checkout@v4

            - name: Install kustomize
              uses: imranismail/setup-kustomize@v2

            - name: Extract version
              id: version
              run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT

            - name: Build production manifests
              run: |
                  cd deploy/overlays/prod
                  kustomize edit set image \
                    ghcr.io/naveed-gung/zero-day-guardian/ebpf-monitor:${{ github.ref_name }} \
                    ghcr.io/naveed-gung/zero-day-guardian/detection-engine:${{ github.ref_name }} \
                    ghcr.io/naveed-gung/zero-day-guardian/guardian-operator:${{ github.ref_name }}
                  cd ../../..
                  kustomize build deploy/overlays/prod > guardian-manifests-${{ steps.version.outputs.VERSION }}.yaml

            - name: Create GitHub Release
              uses: softprops/action-gh-release@v2
              with:
                  files: |
                      guardian-manifests-${{ steps.version.outputs.VERSION }}.yaml
                  generate_release_notes: true
                  draft: false
                  prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
